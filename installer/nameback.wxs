<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="nameback"
           Version="0.7.15"
           Manufacturer="4n6h4x0r"
           UpgradeCode="AFA422AA-7DF2-48F9-A667-488E91D082CE"
           Language="1033"
           InstallerVersion="200"
           Compressed="yes"
           Scope="perMachine">

    <!-- Major upgrade configuration -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of nameback is already installed."
                  AllowSameVersionUpgrades="yes" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="nameback" />
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="nameback"/>
    </StandardDirectory>

    <!-- CLI Executable Component -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="CLIExecutable" Guid="4A908B23-88C4-4DA2-82ED-D0EF1FF1700C">
        <File Id="namebackCLI"
              Source="target\x86_64-pc-windows-msvc\release\nameback.exe"
              KeyPath="yes"
              Checksum="yes" />
        <Environment Id="PATH"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="yes"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </DirectoryRef>

    <!-- GUI Executable Component -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="GUIExecutable" Guid="BA4160CC-4DB8-42C5-8E08-BF5ACE37AB55">
        <File Id="namebackGUI"
              Source="target\x86_64-pc-windows-msvc\release\nameback-gui.exe"
              KeyPath="yes"
              Checksum="yes" />
      </Component>
    </DirectoryRef>

    <!-- PowerShell script for PATH configuration -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="PathConfigScript" Guid="E8A9C1D6-7B2F-4E3A-9A1B-8C5D4F6E7A9B">
        <File Id="AddScoopToPathScript"
              Source="installer\add-scoop-to-path-with-ui.ps1"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- PowerShell script for dependency installation -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="InstallDepsScript" Guid="B7C3D8F1-9A2E-4B6C-8D1F-3E7A9C5B2D4E">
        <File Id="InstallDependenciesScript"
              Source="installer\install-dependencies-with-ui.ps1"
              KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Start Menu shortcut for GUI -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="GUIShortcut" Guid="1408AB73-CDB0-442E-910E-DE2C09B77B8E">
        <Shortcut Id="GUIStartMenuShortcut"
                  Name="nameback"
                  Description="Visual file renaming tool - Rename files based on metadata"
                  Target="[INSTALLFOLDER]nameback-gui.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="NamebackIcon">
          <ShortcutProperty Key="System.AppUserModel.ID" Value="nameback.gui" />
        </Shortcut>
        <RemoveFolder Id="CleanupApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\nameback"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Icon for shortcut (uses GUI executable icon) -->
    <Icon Id="NamebackIcon" SourceFile="target\x86_64-pc-windows-msvc\release\nameback-gui.exe" />

    <!-- Feature includes all components -->
    <Feature Id="Complete"
             Title="nameback"
             Description="Complete installation including CLI and GUI tools"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             Display="expand">

      <Feature Id="CLIFeature"
               Title="Command-line tool"
               Description="CLI tool accessible from any terminal (added to PATH)"
               Level="1">
        <ComponentRef Id="CLIExecutable" />
        <ComponentRef Id="PathConfigScript" />
        <ComponentRef Id="InstallDepsScript" />
      </Feature>

      <Feature Id="GUIFeature"
               Title="GUI application"
               Description="Visual dual-pane file renaming interface with Start Menu shortcut"
               Level="1">
        <ComponentRef Id="GUIExecutable" />
        <ComponentRef Id="GUIShortcut" />
      </Feature>
    </Feature>

    <!-- UI configuration -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Nameback GUI" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WixShellExecTarget" Value="[#namebackGUI]" />

    <UI>
      <!-- Use InstallDir UI for professional installation wizard -->
      <ui:WixUI Id="WixUI_InstallDir" />

      <!-- Custom progress text with ActionData support -->
      <!-- [1] will be replaced with real-time messages from PowerShell script -->
      <ProgressText Action="InstallDependencies" Template="Installing dependencies: [1]" />
      <ProgressText Action="AddScoopToPath" Template="Configuring PATH: [1]" />

      <!-- Launch application after installation -->
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="LaunchApplication"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
    </UI>

    <!-- Custom action to launch the GUI after installation -->
    <CustomAction Id="LaunchApplication"
                  Impersonate="yes"
                  Return="asyncNoWait"
                  FileRef="namebackGUI"
                  ExeCommand="" />

    <!-- Add/Remove Programs metadata -->
    <Property Id="ARPPRODUCTICON" Value="NamebackIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/h4x0r/nameback" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/h4x0r/nameback" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />

    <!-- Custom Action to install dependencies automatically -->
    <!-- Uses PowerShell script with UI progress reporting and logging -->
    <CustomAction Id="InstallDependencies"
                  Directory="INSTALLFOLDER"
                  ExeCommand="powershell.exe -NoProfile -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]install-dependencies-with-ui.ps1&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Custom Action to add Scoop shims and ImageMagick to system PATH after dependency installation -->
    <!-- This ensures exiftool, tesseract, ffmpeg, and imagemagick are accessible system-wide -->
    <!-- Uses external PowerShell script to avoid complex quote escaping -->

    <!-- Immediate action to set the CustomActionData property for the deferred action -->
    <CustomAction Id="SetAddScoopToPathData"
                  Property="AddScoopToPath"
                  Value="[INSTALLFOLDER]add-scoop-to-path-with-ui.ps1" />

    <!-- Deferred action that runs PowerShell script using Directory and CustomActionData -->
    <CustomAction Id="AddScoopToPath"
                  Directory="INSTALLFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand="powershell.exe -NoProfile -ExecutionPolicy Bypass -File &quot;[AddScoopToPath]&quot;" />

    <!-- Schedule the custom actions after files are installed -->
    <InstallExecuteSequence>
      <Custom Action="InstallDependencies" After="InstallFiles" Condition="NOT Installed AND NOT REMOVE" />
      <Custom Action="SetAddScoopToPathData" After="InstallDependencies" Condition="NOT Installed AND NOT REMOVE" />
      <Custom Action="AddScoopToPath" After="SetAddScoopToPathData" Condition="NOT Installed AND NOT REMOVE" />
    </InstallExecuteSequence>

  </Package>
</Wix>
