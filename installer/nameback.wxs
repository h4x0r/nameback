<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="nameback"
           Version="0.8.0"
           Manufacturer="4n6h4x0r"
           UpgradeCode="AFA422AA-7DF2-48F9-A667-488E91D082CE"
           Language="1033"
           InstallerVersion="200"
           Compressed="yes"
           Scope="perMachine">

    <!-- Major upgrade configuration -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of nameback is already installed."
                  AllowSameVersionUpgrades="yes" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="nameback" />
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="nameback"/>
    </StandardDirectory>

    <!-- CLI Executable Component -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="CLIExecutable" Guid="4A908B23-88C4-4DA2-82ED-D0EF1FF1700C">
        <File Id="namebackCLI"
              Source="target\x86_64-pc-windows-msvc\release\nameback.exe"
              KeyPath="yes"
              Checksum="yes" />
        <Environment Id="PATH"
                     Name="PATH"
                     Value="[INSTALLFOLDER]"
                     Permanent="yes"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </DirectoryRef>

    <!-- GUI Executable Component -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="GUIExecutable" Guid="BA4160CC-4DB8-42C5-8E08-BF5ACE37AB55">
        <File Id="namebackGUI"
              Source="target\x86_64-pc-windows-msvc\release\nameback-gui.exe"
              KeyPath="yes"
              Checksum="yes" />
      </Component>
    </DirectoryRef>

    <!-- Bundled Dependencies Directory Structure -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Directory Id="DEPSFOLDER" Name="deps">
        <Directory Id="EXIFTOOLFOLDER" Name="exiftool" />
        <Directory Id="TESSERACTFOLDER" Name="tesseract" />
        <Directory Id="FFMPEGFOLDER" Name="ffmpeg" />
        <Directory Id="IMAGEMAGICKFOLDER" Name="imagemagick" />
      </Directory>
    </DirectoryRef>

    <!-- ExifTool Component -->
    <DirectoryRef Id="EXIFTOOLFOLDER">
      <Component Id="ExifToolDep" Guid="D1E2F3A4-B5C6-47D8-9E0F-1A2B3C4D5E6F">
        <File Id="ExifToolExe"
              Source="target\bundled-deps\exiftool\exiftool.exe"
              KeyPath="yes" />
        <Environment Id="PATH_EXIFTOOL"
                     Name="PATH"
                     Value="[EXIFTOOLFOLDER]"
                     Permanent="yes"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </DirectoryRef>

    <!-- Tesseract Component -->
    <DirectoryRef Id="TESSERACTFOLDER">
      <Component Id="TesseractDep" Guid="E2F3A4B5-C6D7-48E9-0F1A-2B3C4D5E6F7A">
        <File Id="TesseractExe"
              Source="target\bundled-deps\tesseract\tesseract.exe"
              KeyPath="yes" />
        <Environment Id="PATH_TESSERACT"
                     Name="PATH"
                     Value="[TESSERACTFOLDER]"
                     Permanent="yes"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </DirectoryRef>

    <!-- FFmpeg Component -->
    <DirectoryRef Id="FFMPEGFOLDER">
      <Component Id="FFmpegDep" Guid="F3A4B5C6-D7E8-49FA-1B2C-3D4E5F6A7B8C">
        <File Id="FFmpegExe"
              Source="target\bundled-deps\ffmpeg\ffmpeg.exe"
              KeyPath="yes" />
        <File Id="FFprobeExe"
              Source="target\bundled-deps\ffmpeg\ffprobe.exe" />
        <Environment Id="PATH_FFMPEG"
                     Name="PATH"
                     Value="[FFMPEGFOLDER]"
                     Permanent="yes"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </DirectoryRef>

    <!-- ImageMagick Component -->
    <DirectoryRef Id="IMAGEMAGICKFOLDER">
      <Component Id="ImageMagickDep" Guid="A4B5C6D7-E8F9-4A0B-1C2D-3E4F5A6B7C8D">
        <File Id="MagickExe"
              Source="target\bundled-deps\imagemagick\magick.exe"
              KeyPath="yes" />
        <Environment Id="PATH_IMAGEMAGICK"
                     Name="PATH"
                     Value="[IMAGEMAGICKFOLDER]"
                     Permanent="yes"
                     Part="last"
                     Action="set"
                     System="yes" />
      </Component>
    </DirectoryRef>

    <!-- Start Menu shortcut for GUI -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="GUIShortcut" Guid="1408AB73-CDB0-442E-910E-DE2C09B77B8E">
        <Shortcut Id="GUIStartMenuShortcut"
                  Name="nameback"
                  Description="Visual file renaming tool - Rename files based on metadata"
                  Target="[INSTALLFOLDER]nameback-gui.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="NamebackIcon">
          <ShortcutProperty Key="System.AppUserModel.ID" Value="nameback.gui" />
        </Shortcut>
        <RemoveFolder Id="CleanupApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\nameback"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Icon for shortcut (uses GUI executable icon) -->
    <Icon Id="NamebackIcon" SourceFile="target\x86_64-pc-windows-msvc\release\nameback-gui.exe" />

    <!-- Feature includes all components -->
    <Feature Id="Complete"
             Title="nameback"
             Description="Complete installation including CLI and GUI tools"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             Display="expand">

      <Feature Id="CLIFeature"
               Title="Command-line tool"
               Description="CLI tool accessible from any terminal (added to PATH)"
               Level="1">
        <ComponentRef Id="CLIExecutable" />
      </Feature>

      <Feature Id="GUIFeature"
               Title="GUI application"
               Description="Visual dual-pane file renaming interface with Start Menu shortcut"
               Level="1">
        <ComponentRef Id="GUIExecutable" />
        <ComponentRef Id="GUIShortcut" />
      </Feature>

      <Feature Id="DependenciesFeature"
               Title="External dependencies"
               Description="Bundled tools: exiftool, tesseract, ffmpeg, imagemagick"
               Level="1">
        <ComponentRef Id="ExifToolDep" />
        <ComponentRef Id="TesseractDep" />
        <ComponentRef Id="FFmpegDep" />
        <ComponentRef Id="ImageMagickDep" />
      </Feature>
    </Feature>

    <!-- UI configuration -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Nameback GUI" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WixShellExecTarget" Value="[#namebackGUI]" />

    <UI>
      <!-- Use InstallDir UI for professional installation wizard -->
      <ui:WixUI Id="WixUI_InstallDir" />

      <!-- Launch application after installation -->
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="LaunchApplication"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed" />
    </UI>

    <!-- Custom action to launch the GUI after installation -->
    <CustomAction Id="LaunchApplication"
                  Impersonate="yes"
                  Return="asyncNoWait"
                  FileRef="namebackGUI"
                  ExeCommand="" />

    <!-- Add/Remove Programs metadata -->
    <Property Id="ARPPRODUCTICON" Value="NamebackIcon" />
    <Property Id="ARPHELPLINK" Value="https://github.com/h4x0r/nameback" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/h4x0r/nameback" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />


  </Package>
</Wix>
